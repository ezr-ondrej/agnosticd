---
- name: Remove rh-amazon-rhui-client package
  tags: packer
  package:
    name: rh-amazon-rhui-client
    state: absent
  when: cloud_provider == 'aws'

- name: Remove all Red Hat repositories
  redhat_subscription:
    state: absent
  ignore_errors: yes

- name: Purge subscriptions
  shell: 'subscription-manager clean'

- name: Remove satellite Cert
  tags: packer
  package:
    name: katello-ca-consumer-*.noarch
    state: absent

- name: Download Cert from Satellite
  get_url:
    url: "https://{{ satellite_hostname }}/pub/katello-ca-consumer-latest.noarch.rpm"
    dest: /root/katello-ca-consumer-latest.noarch.rpm
    mode: 0664
    validate_certs: no

- name: Install Cert
  # use rpm here to avoid issue when yum is broken (chicken&egg)
  command: "rpm -Uvh /root/katello-ca-consumer-latest.noarch.rpm"
  args:
    warn: no

- name: Delete Cert Package
  file:
    name: /root/katello-ca-consumer-latest.noarch.rpm
    state: absent

- name: Register with activation-key
  redhat_subscription:
    state: present
    server_hostname: "{{ satellite_hostname }}"
    activationkey: "{{ satellite_hosts_register_key }}"
    org_id: "{{ org_label }}"

# - name: Enable Repositories
#   command: subscription-manager repos --enable=rhel-7-server-satellite-tools-6.3-rpms

# - name: Install Katello Agent
#   yum:
#     name: katello-agent
#     state: latest

# - name: Start Katello Agent
#   service:
#     name: goferd
#     state: started
#     enabled: yes

- name: Enable repos
  rhsm_repository:
    name: "*"
    state: enabled

- name: Fetch smart proxies from the satellite
  uri:
    url: "https://{{ satellite_hostname }}/api/v2/smart_proxies"
    user: "{{ satellite_admin }}"
    password: "{{ satellite_admin_password }}"
    validate_certs: "{{ validate_certs | default(True) }}"
    force_basic_auth: True
  register: result

- name: Output of results
  debug:
    msg: " {{ result['json'] }} "

- name: set the remote_execution_pubkey
  set_fact:
    remote_execution_pubkey: "{{ result['json'] | json_query('results[*].remote_execution_pubkey') | join('') }}"

- name: Add the remote_execution_key to authorized keys
  authorized_key:
    user: "{{ remote_execution_user | d('root') }}"
    state: present
    key: "{{ remote_execution_pubkey }}"